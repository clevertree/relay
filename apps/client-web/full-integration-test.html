<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full Integration Test</title>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-left: 3px solid #007acc; background: #252526; }
        .pass { border-left-color: #4ec9b0; }
        .fail { border-left-color: #f48771; }
        pre { background: #1e1e1e; padding: 5px; margin: 5px 0; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîó Full JSX Transpiler Integration Test</h1>
    <div id="output"></div>

    <script type="module">
        const out = document.getElementById('output');

        function log(msg, type = 'info') {
            console.log(msg);
            const div = document.createElement('div');
            div.className = `result ${type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : ''}`;
            div.innerHTML = msg;
            out.appendChild(div);
        }

        (async () => {
            try {
                // Step 1: Load WASM
                log('Step 1: Importing WASM module from /src/wasm/hook_transpiler.js');
                const wasmMod = await import('/src/wasm/hook_transpiler.js');
                log('‚úì WASM module imported', 'pass');
                log(`Available exports: ${Object.keys(wasmMod).join(', ')}`);

                // Step 2: Initialize
                log('<br>Step 2: Calling init function');
                if (typeof wasmMod.default === 'function') {
                    await wasmMod.default();
                    log('‚úì WASM initialized', 'pass');
                } else {
                    log('‚ö† No init function, continuing anyway');
                }

                // Step 3: Test direct function
                log('<br>Step 3: Testing transpile_jsx function directly');
                const testCode = '<div className="test">Hello</div>';
                const result = wasmMod.transpile_jsx(testCode, 'test.jsx');
                log(`Input: <code>${testCode}</code><br>Output: <code>${result}</code>`, 
                    result.includes('h(div') ? 'pass' : 'fail');

                // Step 4: Set up global
                log('<br>Step 4: Setting up globalThis.__hook_transpile_jsx');
                globalThis.__hook_transpile_jsx = wasmMod.transpile_jsx.bind(wasmMod);
                log('‚úì Global function ready', 'pass');

                // Step 5: Simulate what runtimeLoader.ts does
                log('<br>Step 5: Testing runtimeLoader.ts transpilation pattern');
                const hookCode = `
export default async function getClient(ctx) {
    const { createElement: h } = ctx;
    return <div>Hello</div>;
}`;
                
                const wasmTranspile = globalThis.__hook_transpile_jsx;
                const filename = 'get-client.jsx';
                const out1 = await wasmTranspile(hookCode, filename);
                
                log(`<strong>Hook code transpilation:</strong><br>
Input:<br><code>${escapeHtml(hookCode)}</code><br>
Output:<br><code>${escapeHtml(out1)}</code>`,
                    out1.includes('h(div') ? 'pass' : 'fail');

                // Step 6: Test with attributes
                log('<br>Step 6: Testing attributes parsing');
                const withAttrs = '<Button onClick={handleClick} className="btn-primary" />';
                const out2 = wasmTranspile(withAttrs, 'button.jsx');
                log(`Input: <code>${withAttrs}</code><br>Output: <code>${escapeHtml(out2)}</code>`,
                    out2.includes('h(Button') ? 'pass' : 'fail');

                // Summary
                log('<br><strong>=== ALL TESTS COMPLETE ===</strong><br>‚úÖ JSX transpiler is fully integrated and working!', 'pass');

            } catch (err) {
                log(`‚ùå ERROR: ${err.message}<br><pre>${err.stack}</pre>`, 'fail');
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        })();
    </script>
</body>
</html>
