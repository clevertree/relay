openapi: 3.0.3
info:
  title: Relay API
  version: 0.1.0
  description: |
    The Relay API exposes CRUD operations on a Git repository with branch and repository selection via headers or cookies.
    Disallowed file types for writes: .html, .htm, .js
servers:
  - url: http://localhost:8088
    description: Local Relay server
tags:
  - name: files
    description: File CRUD and query
  - name: system
    description: Server status and capabilities
paths:
  /{path}:
    parameters:
      - in: header
        name: X-Relay-Branch
        schema:
          type: string
          default: main
        required: false
        description: Git branch to use
      - in: header
        name: X-Relay-Repo
        schema:
          type: string
        required: false
        description: Repository subdirectory to use (top-level folder name)
      - in: path
        name: path
        required: true
        schema:
          type: string
        description: Repository-relative path (URL-encoded)
    get:
      tags: [files]
      summary: Read file contents from a branch
      operationId: getFile
      responses:
        '200':
          description: Raw file bytes
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '403':
          description: Disallowed file type
        '404':
          description: File not found
    put:
      tags: [files]
      summary: Create or update a file on a branch, committing the change
      operationId: putFile
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: File written and committed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WriteResponse'
        '403':
          description: Disallowed file type
    delete:
      tags: [files]
      summary: Delete a file from a branch, committing the change
      operationId: deleteFile
      responses:
        '200':
          description: File deleted and committed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WriteResponse'
        '404':
          description: File not found
        '403':
          description: Disallowed file type
  /:
    options:
      tags: [system]
      summary: "Discovery: capabilities, branches, repos, and current selections"
      operationId: optionsRoot
      responses:
        '200':
          description: Discovery payload
          headers:
            Allow:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptionsResponse'
  '/{any*}':
    options:
      tags: [system]
      summary: Discovery for a specific path
      operationId: optionsAny
      responses:
        '200':
          description: Discovery payload
          headers:
            Allow:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptionsResponse'
components:
  schemas:
    OptionsResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        repoInitialized:
          type: boolean
        capabilities:
          type: array
          items:
            type: string
          example: [git, torrent, ipfs, http]
        branches:
          type: array
          items:
            type: string
        repos:
          type: array
          items:
            type: string
          description: Top-level directories considered repositories
        currentBranch:
          type: string
        currentRepo:
          type: string
        branchHeads:
          type: array
          description: Current HEAD commit per branch; filtered by request headers/query when provided
          items:
            type: object
            properties:
              branch:
                type: string
              commit:
                type: string
        samplePaths:
          type: object
          additionalProperties:
            type: string
          example:
            index: index.md
    WriteResponse:
      type: object
      properties:
        branch:
          type: string
        path:
          type: string
        commit:
          type: string
  x-relay:
    methods:
      QUERY:
        summary: Custom method for server-side queries against the repository according to policy
        notes: "This non-standard method may be blocked by some proxies. Clients should send directly to the server."
