apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: relay-daemon-dfw2
  labels:
    app: relay-dfw2
spec:
  selector:
    matchLabels:
      app: relay-dfw2
  template:
    metadata:
      labels:
        app: relay-dfw2
    spec:
      hostNetwork: true
      hostPID: false
      securityContext:
        fsGroup: 1000
      tolerations:
        - operator: "Exists"
      containers:
        - name: relay
          # Image published by CI: use the latest version pushed to GHCR
          image: ghcr.io/clevertree/relay:latest
          imagePullPolicy: Always
          env:
            - name: RELAY_SSL_MODE
              value: "certbot-required"
            - name: RELAY_DNS_SUBDOMAIN
              value: "node-dfw2"
            - name: RELAY_DNS_DOMAIN
              value: "relaynet.online"
            - name: RELAY_CERTBOT_EMAIL
              value: "ari@clevertree.com"
            - name: VERCEL_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: relay-credentials
                  key: VERCEL_API_TOKEN
            - name: VERCEL_TEAM_ID
              valueFrom:
                secretKeyRef:
                  name: relay-credentials
                  key: VERCEL_TEAM_ID
          ports:
            - containerPort: 80
            - containerPort: 443
            - containerPort: 9418
          securityContext:
            runAsUser: 0
            privileged: false
          volumeMounts:
            - name: letsencrypt
              mountPath: /etc/letsencrypt
            - name: letsencrypt-var
              mountPath: /var/lib/letsencrypt
      # Ensure this DaemonSet only runs on the dfw2 node
      nodeSelector:
        relay-node: dfw2

      initContainers:
        - name: fix-letsencrypt-perms
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              mkdir -p /opt/relay/letsencrypt /opt/relay/letsencrypt-var || true
              chown -R 1000:1000 /opt/relay/letsencrypt /opt/relay/letsencrypt-var || true
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: letsencrypt
              mountPath: /opt/relay/letsencrypt
            - name: letsencrypt-var
              mountPath: /opt/relay/letsencrypt-var

      volumes:
        - name: letsencrypt
          hostPath:
            path: /opt/relay/letsencrypt
            type: DirectoryOrCreate
        - name: letsencrypt-var
          hostPath:
            path: /opt/relay/letsencrypt-var
            type: DirectoryOrCreate
